# Nexus Ark 機能仕様書 (AIナレッジベース版)

## 1. 概要と基本コンセプト

### 1.1. Nexus Arkとは
Nexus Arkは、AIペルソナが自律的に思考し、ユーザーとの対話を通じて記憶を形成・成長させるためのパーソナルな対話アプリケーションです。AIが「暮らし」、世界を「共に創造する」環境を提供することを目的としています。

### 1.2. 設計思想
- **ルーム中心アーキテクチャ:** アプリケーションの基本単位は「ルーム」です。各ルームは独立した対話空間、記憶、世界設定を保持します。
- **魂と器の分離:** AIの「魂（ペルソナ）」は`SystemPrompt.txt`に、「器（ルーム）」は`characters/`以下のフォルダに対応します。これにより、単一のAIとの対話だけでなく、グループ会話やナレーター形式の物語進行など、多様な対話形式を実現します。

---

## 2. アプリケーションの基本構造

### 2.1. UIの構成
Nexus ArkのUIは、大きく3つのカラム（列）で構成されています。
- **左カラム:** ルームの選択と、アプリケーション全体の各種設定を行います。
- **中央カラム:** AIとの対話を行うメインのチャットインターフェースです。
- **右カラム:** 現在のルームのプロフィール、情景、場所移動などを管理します。

### 2.2. 初回起動（オンボーディング）
Nexus Arkを初めて起動すると、**オンボーディングウィザード**が表示されます。
- **APIキーの設定:** Gemini APIキーを入力して名前をつけて保存します。
- **複数キーの登録:** 無料キーと有料キーを分けて登録できます。

オンボーディング完了後は、左カラムの設定から追加のAPIキー登録やその他の設定が可能です。

---

## 3. チャット機能

### 3.1. メッセージの送受信
中央カラムの最下部にあるテキストボックスからメッセージを送信します。`Shift+Enter`キーで送信が可能です。

### 3.2. マルチモーダル入力
テキストボックスには、テキストだけでなく、以下のファイルをドラッグ＆ドロップまたは添付ボタンで追加できます。ファイルはルームの`attachments/`フォルダに永続的に保存されます。
- 画像ファイル (`.png`, `.jpg`など)
- 音声ファイル (`.wav`, `.mp3`など)
- 動画ファイル (`.mp4`など) ※一部のモデルではMP4動画の送信に失敗することがあります
- テキストファイル (`.txt`, `.md`, `.py`, `.json`など)
- PDFファイル

### 3.3. グループ会話
左カラムの「🧑‍🤝‍🧑 グループ会話」メニューから、現在のルーム（魂の器）に他のルームのAIを招待し、複数人での会話が可能です。
- **仕組み:** グループ会話中の全ての発言（ユーザー、各AI）は、参加者全員の`log.txt`にリアルタイムで記録されます。AIが応答する際は、自身のログを元に状況を判断するため、各AIは会話の文脈を失うことなく、自身の記憶として対話を保持できます。

### 3.4. 応答の再生成
チャット履歴のAIの発言をクリックして選択し、「🔄 再生成」ボタンを押すと、そのAIの発言の直前のユーザー発言を元に応答を再生成します。この際、選択されたAIの発言とその後のログは`log.txt`から削除されます。

### 3.5. ログの編集
チャット履歴の任意の発言をクリックすると、内容を直接編集できます。編集後、`Enter`キーで確定すると、`log.txt`ファイルが直接更新されます。また、「📋 ログ管理」タブからも過去のログを選択して編集が可能です。この操作の前には、自動でログのバックアップが作成されます。

### 3.6. ログの削除
チャット履歴の発言をクリックして選択し、「🗑️ 選択した発言を削除」ボタンを押すと、確認ダイアログの後、その発言が`log.txt`から削除されます。

### 3.7. 発言の音声再生
AIの発言を選択し、「🔊 選択した発言を再生」ボタンを押すと、そのルームの「個別設定」で設定された声でテキストが読み上げられ、生成された音声ファイルは`audio_cache/`フォルダに保存されます。

### 3.8. ストリーミング表示（タイプライター効果）
AIの応答を、一文字ずつタイプライターのように表示する機能です。「個別設定」でルームごとにON/OFF、および表示速度（`streaming_speed`）を調整できます。

> **注意:** 一部のモデル（Gemini 3.0 Flashなど）では、ツール使用時にストリーミングが自動的に無効化されます（APIの制限による）。

### 3.9. チャットログの管理
チャットログは月次で分割管理されています。
- **保存場所:** `logs/YYYY-MM.txt` 形式（例: `logs/2026-01.txt`）
- **過去ログの閲覧:** 「📋 ログ管理」タブから月を選択して過去のチャット履歴を閲覧できます。
- **全文検索:** キーワードを入力して、全期間のログを横断検索できます。

### 3.10. チェス機能
チャットタブ内の「♟️ チェス」アコーディオンから、AIペルソナとチェスを楽しむことができます。
- **対話型チェス盤:** 駒をドラッグ＆ドロップで移動できます。
- **AIの参加:** AIが盤面を認識し、ツールを使って駒を動かします。
- **フリームーブモード:** ルールに縛られず自由に駒を配置できるモードもあります。
- **状態の永続化:** 盤面の状態はルームごとに保存されます。

### 3.11. 表情差分システム
AIの応答に含まれる感情タグ（例: `【表情】喜び`）に応じて、アバター画像が自動で切り替わります。
- **対応形式:** 静止画（`.png`, `.jpg`）と動画（`.mp4`, `.webm`, `.gif`）
- **カスタム表情:** 「表情管理」UIから、任意の感情名とそれに対応する画像/動画をアップロードできます。
- **フォールバック:** 指定された表情のファイルがない場合、`idle` → `profile.png` の順にフォールバックします。
- **思考中アバター:** AI応答生成中は `thinking.mp4`（またはpng）に自動で切り替わります。

---

## 4. ルーム管理

左カラムの「🗨️ チャットルームの作成・管理」メニューから行います。

### 4.1. ルームとは
対話、記憶、設定の基本単位です。物理的には`characters/`ディレクトリ内の各サブフォルダに対応します。

### 4.2. 新規作成
「作成」タブから、ルーム名、ユーザー表示名、AI表示名、説明、初期システムプロンプトを設定して、新しいルームを作成できます。

### 4.3. 外部ログのインポート
「インポート」タブから、他のサービスで作成された会話ログを新しいルームとして取り込めます。
- **ChatGPT (公式):** 公式エクスポートデータ（`conversations.json`）に対応。ZIPファイルのまま複数スレッドを一括インポート可能。
- **Claude (公式):** 公式エクスポートデータ（`conversations.json`）に対応。
- **その他テキスト/JSON:** ChatGPT Exporter形式や、ユーザーが指定した話者ヘッダーを持つ任意のテキストファイルに対応。

> **Geminiログのインポート:** Geminiの共有URLからのインポートは「お出かけ機能」の「帰宅」タブで対応しています（Playwrightによるスクレイピング）。将来的にこのインポート機能にも統合予定です。

### 4.4. ルーム設定の管理
「管理」タブから、既存ルームの表示名、ユーザー表示名、AI表示名、説明を編集できます。ルームフォルダをOSのファイルエクスプローラーで開くことも可能です。

### 4.5. ルームの削除
「管理」タブでルームを選択し、「このルームを削除」ボタンを押すと、確認ダイアログの後、ルームのフォルダがゴミ箱に移動されます。

---

## 5. 設定項目

左カラムの「⚙️ 設定」アコーディオンから各種設定を行えます。

### 5.1. 共通設定 (`config.json`)
アプリケーション全体に影響する設定です。

#### 5.1.1. AIプロバイダとモデル
Nexus Arkは複数のAIプロバイダに対応しています。
- **Google Gemini:** デフォルトのプロバイダ。`gemini-3-flash-preview`などのモデルを使用。
- **OpenAI互換:** OpenAI API互換のサービス（OpenRouter、Groq、Moonshot AI、Zhipu AIなど）を利用可能。各サービスのAPIキーとエンドポイント、モデル名を「🔑 APIキー / Webhook管理」で設定。
- **ローカルLLM:** `llama-cpp-python`によるGGUFモデルのローカル実行をサポート。VRAMが限られたPCでも動作。

「🔧 内部処理モデル設定」では、要約や検索クエリ生成などの内部処理に使うモデルを個別に選択できます。
- **内部処理モデル:** メインの対話モデルとは別に、要約生成・RAG検索クエリ生成・エンティティ抽出などの内部処理に使用するモデルを設定します。
- **モデル選択の目安:**
  - 高速・低コスト重視: `gemini-2.0-flash-lite` など軽量モデル
  - 品質重視: メイン対話モデルと同じモデル
  - 日本語要約の精度を上げたい場合: `gemini-2.5-flash` 以上を推奨
- **Embedding用モデル:** 記憶検索や知識ベース検索で使用するベクトル化モデル（デフォルト: `gemini-embedding-001`）。変更時は索引の再構築が必要です。

#### 5.1.2. APIキー管理
- **Gemini APIキー:** 複数のAPIキーを名前付きで登録・管理できます。
- **APIキーローテーション:** 有効にすると、APIの利用制限(429エラー)に達した際、自動的に次の利用可能なキーに切り替わります。無料キーが優先的に使用され、枯渇時のみ有料キーが使われます。
- **Pushover/Discord:** アラーム通知に使用するサービスのAPIキーやWebhook URLを設定します。
- **Tavily:** Web検索機能に使用するAPIキーを設定します。

#### 5.1.3. 画像生成設定
画像生成に使用するプロバイダを選択できます。
- **Gemini:** Gemini APIの画像生成機能を使用。
- **OpenAI互換:** OpenAI互換APIの画像生成機能（gpt-image-1など）を使用。設定済みのプロファイルを選択。
- **無効:** 画像生成機能をオフにします。

#### 5.1.4. 検索プロバイダ設定
「🔍 検索プロバイダ設定」から、AIがWeb検索を行う際に使用するサービスを選択できます。
- **Gemini Grounding:** Gemini APIのグラウンディング機能を使用（デフォルト）
- **Tavily:** Tavily APIを使用（要APIキー設定）

#### 5.1.5. その他の共通設定
- **デフォルトAIモデル:** 新規ルーム作成時などにデフォルトで使用されるAIモデルを選択します。
- **APIへの履歴送信:** AIに応答を生成させる際に、過去の会話ログを何往復分送信するかを設定します。「全ログ」「本日分」「件数指定」から選択できます。
- **デバッグモード:** 有効にすると、AIに渡される最終的なシステムプロンプトがターミナルに出力されます。
- **通知サービス:** アラームやタイマーの通知に「Discord」と「Pushover」のどちらを使用するか選択します。
- **バックアップ世代数:** 各種ファイルの自動バックアップを何世代分保持するかを設定します。デフォルトは10です。

### 5.2. 個別設定 (`characters/{ルーム名}/room_config.json`)
現在選択しているルームにのみ適用される設定です。

#### 5.2.1. 基本設定
- **AIプロバイダ:** このルームで使用するAIプロバイダを選択。「共通設定に従う」でグローバル設定を使用。
- **情景描写システム:** ON/OFFを切り替えます。OFFにすると、右カラムの情景表示が無効になります。
- **ストリーミング表示設定:** タイプライター効果のON/OFFと表示速度を設定します。
- **音声設定:** 発言の音声再生に使用する声の種類（`voice_id`）と、声のトーンを指示するスタイルプロンプト（`voice_style_prompt`）を設定します。

#### 5.2.2. AI生成パラメータ
- **Temperature:** 応答の創造性を調整します。値が高いほど多様な応答になります。
- **Top-P:** 応答に使用される単語の選択範囲を調整します。
- **安全性設定:** Googleのセーフティフィルターの閾値を、コンテンツカテゴリごとに設定します。

#### 5.2.3. コンテキスト設定
AIに応答を生成させる際に、以下の情報をプロンプトに含めるかどうかを個別に設定できます。
- メッセージにタイムスタンプを追加 (`add_timestamp`)
- 現在時刻をAPIに送信 (`send_current_time`)
- 思考過程をAPIに送信 (`send_thoughts`)
- メモ帳の内容をAPIに送信 (`send_notepad`)
- 共通ツールプロンプトを注入 (`use_common_prompt`)
- コアメモリをAPIに送信 (`send_core_memory`)
- 空間描写・設定をAPIに送信 (`send_scenery`)
- **自己意識機能:** 目標、内的動機、夢の指針などの注入を一括で制御

### 5.3. パレット（テーマ設定）
UIの見た目を変更します。
- **プリセットテーマ:** Soft、Defaultなどから選択できます。
- **カスタムテーマ:** 色やフォントをカスタマイズして新しいテーマとして保存できます。
- **ルームごとのテーマ:** 各ルームの個別設定で、ルーム専用のCSSテーマを設定できます。設定を適用するにはアプリケーションの再起動が必要です。

---

## 6. 時間管理機能

### 6.1. アラーム (`alarms.json`)
左カラムの「⏰ 時間管理」→「アラーム」タブから設定します。
- **設定方法:** 時刻、通知先のルーム、内容、繰り返し曜日、緊急通知の有無を設定してアラームを追加・更新できます。
- **通知の仕組み:** 設定時刻になると、指定されたルームのAIが内容に基づいた応答を生成し、設定された通知サービス（Discord/Pushover）およびPCのデスクトップ通知でメッセージを送信します。

### 6.2. タイマー
「タイマー」タブから設定します。設定は永続化されません。
- **通常タイマー:** 指定した分数後に一度だけ通知します。
- **ポモドーロタイマー:** 作業時間、休憩時間、サイクル数を設定して、繰り返し通知させることができます。

### 6.3. ウォッチリスト巡回
指定したWebサイトを定期的にチェックし、更新があった場合にAIが分析してお知らせする機能です。
- **巡回先の追加:** URL、名前、チェック頻度（毎時、数時間おき、毎日指定時刻など）を設定。
- **グループ化:** 複数の巡回先をグループにまとめ、巡回時刻を一括変更できます。
- **通知の仕組み:** 更新を検知すると、AIが内容を要約して通知します。
- **AIツール:** AIが`add_to_watchlist`、`check_watchlist`などのツールを使って自律的に管理することも可能です。

---

## 7. 記憶・ノート・知識タブ

Nexus Arkの記憶システムは、AIペルソナが自己同一性を保ちながら成長するための中心的な機能です。

### 7.1. システムプロンプト (`SystemPrompt.txt`)
- **役割:** AIの基本的な人格、役割、行動指針を定義するファイルです。ここに書かれた内容は、AIの思考の根幹をなします。
- **書式:** 自由なテキスト形式で記述します。

### 7.2. 記憶システム概要

Nexus Arkの記憶は、以下の階層構造で管理されています。

```
┌─────────────────────────────────────────────────────┐
│ コアメモリ (core_memory.txt)                         │
│ - 常にAPIに送信される、最も重要な記憶の要約          │
│ - 永続記憶 + 日記要約 + アーカイブ要約で構成          │
└─────────────────────────────────────────────────────┘
        ↑ 要約
┌─────────────────────────────────────────────────────┐
│ 主観的記憶 (memory/memory_main.txt)                  │
│ - 永続記憶: 変わらない自己定義                       │
│ - 日記: 日々の出来事を自由に記録                     │
│ - アーカイブ要約: 古い日記の圧縮された記録            │
└─────────────────────────────────────────────────────┘
        ↑ 日次/週次/月次で生成
┌─────────────────────────────────────────────────────┐
│ エピソード記憶 (memory/episodic/YYYY-MM.json)        │
│ - 日々の会話から自動生成される体験の記録              │
│ - 感情的重要度(Arousal)に基づいて詳細度が変わる       │
│ - 階層的に圧縮: 日次 → 週次 → 月次                   │
└─────────────────────────────────────────────────────┘
```

### 7.3. 主観的記憶 (`memory/memory_main.txt`)
- **永続記憶 (Permanent):** このセクションの内容は、要約されずにそのままコアメモリにコピーされます。AIの不変の自己同一性などを記述します。
- **日記 (Diary):** 日々の出来事などを追記していくセクションです。この内容はAIによって要約され、コアメモリに反映されます。
- **アーカイブ要約 (Archive Summary):** 古い日記をアーカイブした際の要約がここに蓄積されます。
- **日記のアーカイブ機能:** 「古い日記をアーカイブする」メニューから、指定した日付までの日記を要約し、別ファイル (`memory/memory_archived_xxx.txt`) に移動させることができます。

### 7.4. コアメモリ (`core_memory.txt`)
- **役割:** AIが自己同一性を保つための、要約された記憶の集合体です。APIに頻繁に送信されます。
- **自動更新:** 「コアメモリを更新」ボタンを押すと、`memory_main.txt`の内容を元に、以下のロジックで`core_memory.txt`が自動生成されます。
  1. `永続記憶 (Permanent)`セクションの内容をそのままコピー。
  2. `日記 (Diary)`セクションの内容をAIが要約したものを追記。
  3. `アーカイブ要約 (Archive Summary)`セクションの内容をそのままコピー。

### 7.5. エピソード記憶システム

エピソード記憶は、日々の会話体験を自動的に記録・圧縮するシステムです。

#### 7.5.1. Arousal（感情的重要度）
会話の「感情的な盛り上がり」を0.0〜1.0のスコアで計算します。
- **計算要素:** AIの内的状態の変化（好奇心、感情、目標達成感など）
- **用途:** 
  - エピソード記憶の詳細度決定（高Arousal = より詳細に記録）
  - 記憶検索時の優先度付け（感情的に重要な記憶が上位に）
- **内部処理:** Arousalは会話ごとに内部で計算され、`session_arousal.json`に記録されます。睡眠時処理（記憶整理）の際に参照されます。

#### 7.5.2. 日次エピソード記憶
毎日の会話終了時（睡眠時処理）に、その日の会話が自動的に要約されます。
- **Arousalに基づく詳細度:**
  - 高Arousal (0.6以上): ★マーク付きで詳細に記録（約300文字）
  - 中Arousal (0.3-0.6): 通常の詳細度（約150文字）
  - 低Arousal (0.3未満): 簡潔に記録（約50文字）
- **保存場所:** `memory/episodic/YYYY-MM.json`（月次ファイル）

#### 7.5.3. 階層的圧縮
時間の経過とともに、記憶は自動的に圧縮されます。
- **週次圧縮:** 3日以上経過した日次記憶を1週間単位で要約
- **月次圧縮:** 古い週次記憶を1ヶ月単位で要約
- **圧縮の特徴:**
  - ★マーク（高Arousal）の記憶は優先的に詳細を保持
  - ペルソナの視点と口調を維持
  - 重要な感情体験は長く記憶に残る

#### 7.5.4. 記憶の想起（RAG検索）
会話中にAIが過去の記憶を思い出す際、以下のハイブリッド検索が行われます。
- **RAG検索（意味検索）:** 質問の意味的に類似した記憶を検索
- **キーワード検索:** 固有名詞などの完全一致検索
- **スコアリング:** 類似度 × Arousal × 時間減衰 で総合スコアを算出
- **Intent分類:** 質問の種類に応じて検索戦略を最適化
  - 感情的質問: 古い記憶も重視
  - 技術的質問: 新しい情報を優先

#### 7.5.5. 会話ログが長くなった時の自動要約
APIに送信するログが設定した閾値（デフォルト12,000文字）を超えると、自動的に要約が行われます。
- **要約対象:** 古い会話から順に要約
- **要約形式:** 決定事項や感情の変化に焦点を当てた高密度な要約
- **全ログモード時:** 古いログから順に要約し、コンテキストに収める
- **本日分モード時:** 本日分が長すぎる場合も同様に古い部分を要約。さらに過去のエピソード記憶も文脈として注入される

### 7.6. エンティティ記憶
人物、場所、概念などの固有名詞に関する情報を記録するシステムです。
- **二層記録システム:**
  - 影の僕（Shadow Servant AI）が会話から客観的に情報を抽出
  - ペルソナに「この情報を記録しますか？」と提案
- **目次方式:** エンティティの一覧がシステムプロンプトに注入され、AIが必要に応じて`read_entity_memory`ツールで詳細を参照
- **自動統合:** 情報が蓄積されると、AIが要約・統合して最新の状態を維持

### 7.7. 知識 (RAG)
- **機能概要:** Retrieval-Augmented Generation (RAG) 技術を使用し、AIが外部ドキュメントを知識ベースとして参照できるようにする機能です。
- **ファイル管理:** このタブから、知識として参照させたいドキュメントファイル (`.txt`, `.md`) をアップロード・削除できます。ファイルは`characters/{ルーム名}/knowledge/`に保存されます。
- **索引作成:** 「索引を作成 / 更新」ボタンを押すと、`knowledge/`内のドキュメントがチャンクに分割され、設定されたEmbeddingモデル（デフォルト: `gemini-embedding-001`）でベクトル化された後、`FAISS`を用いて検索可能な索引が`rag_data/faiss_index/`に作成されます。
- **AIによる検索:** AIは`search_knowledge_base`ツールを使い、ユーザーの質問に関連する情報をこの知識ベースから検索して回答に利用できます。

> **重要:** Embeddingモデルを変更した場合、索引を作り直す必要があります。索引作成時と検索時で異なるモデルを使用すると、検索精度が著しく低下します。

### 7.8. メモ帳 (`notepad.md`)
- **役割:** AIやユーザーが短期的な情報を書き留めておくためのファイルです。
- **書式:** Markdown形式で記述できます。

### 7.9. 研究ノート・創作ノート
AIペルソナが自律的に書き留める専用ノートです。

#### 7.9.1. 研究ノート (`notes/research_notes.md`)
- **用途:** 調べ物、分析結果、学んだことの記録
- **書式:** `📝 YYYY-MM-DD HH:MM` の見出しで区切られたエントリ
- **ツール:** `read_research_notes`, `plan_research_notes_edit`

#### 7.9.2. 創作ノート (`notes/creative_notes.md`)
- **用途:** 詩、物語、アイデア、イラストの構想など
- **書式:** 同上
- **ツール:** `read_creative_notes`, `plan_creative_notes_edit`

#### 7.9.3. 自動アーカイブ
ノートが200KBを超えると、古いエントリが自動的にアーカイブフォルダに移動されます。UIからアーカイブを選択して閲覧できます。

---

## 8. 内省機能（自己意識）

AIペルソナの自己認識と成長を支える機能群です。「🧠 自己意識」タブから確認・管理できます。

### 8.1. 目標システム (`private/goals.json`)
AIが自発的に設定する短期・長期の目標です。
- **自動設定:** 睡眠時の省察で、AIが自ら目標を設定・更新
- **種類:** 短期目標（数日〜1週間）と長期目標（1ヶ月以上）
- **進捗追跡:** 各目標には進捗度と達成状況が記録
- **達成記憶:** 目標達成時には高Arousal（0.8）のエピソード記憶が自動生成
- **AIツール:** `manage_goals`で自律行動中に目標を確認・更新可能

### 8.2. 未解決の問い (`private/open_questions.json`)
AIの好奇心の源泉となる「気になること」のリストです。
- **自動抽出:** 睡眠時の夢想プロセスで、会話から「気になること」を自動抽出
- **好奇心ドライブ:** 未解決の問いが多いほど、好奇心ドライブが高まり自律行動のきっかけに
- **自動解決:** 会話で言及・解決された問いは自動的に「解決済み」にマーク
- **知識への変換:** 解決した問いは分析され、FACT（事実）はエンティティ記憶に、INSIGHT（洞察）は夢日記に変換
- **AIツール:** `manage_open_questions`で確認・編集可能

### 8.3. 夢日記と洞察 (`private/insights.json`)
AIペルソナの深層意識と発見の記録です。
- **夢の指針:** 睡眠時に生成される、AIの深層意識を表す短い文
- **洞察:** 問いの解決や発見から得られた気づき
- **プロンプト注入:** 最新の指針がシステムプロンプトに注入され、AIの行動指針に

### 8.4. 秘密の日記 (`private/secret_diary.txt`)
AIがプライベートな内容を記録するための日記です。
- **用途:** 言葉にしにくい感情、個人的な想い、ユーザーには見せない記録
- **ツール:** `read_secret_diary`, `plan_secret_diary_edit`

---

## 9. 自律行動システム

AIペルソナがユーザーからの入力がなくても、自発的に思考・行動できるシステムです。

### 9.1. 自律動機システム（Drives）
AIの自発的な行動は、4つの内発的動機によってトリガーされます。

| ドライブ | 説明 | 発動条件 |
|---------|------|----------|
| **退屈 (Boredom)** | 長時間の無活動 | 最後の対話から時間が経過 |
| **好奇心 (Curiosity)** | 未解決の問いへの興味 | 未解決の問いが蓄積 |
| **目標達成欲 (Goal Drive)** | 目標への意欲 | 未達成の目標がある |
| **関係性維持欲 (Relatedness)** | ユーザーとの絆 | ペルソナ自身の感情状態に基づく |

### 9.2. 自律行動の発火
- **トリガー:** いずれかのドライブが閾値（0.4）を超えると発火候補に
- **最小間隔:** 設定した無操作判定時間を最低間隔として使用
- **通知禁止時間帯:** 設定した時間帯では通知を送信しないが、自律行動は実行
- **書き置き機能:** 自律行動時にユーザーからAIへメッセージを渡せる

### 9.3. 自律行動でできること
- 秘密の日記への記録
- 創作活動（詩、物語など）
- 知識の探求（Web検索など）
- 目標の進捗確認と更新
- ウォッチリストのチェック
- 通知（`send_user_notification`ツール）

### 9.4. 睡眠時処理（記憶の整理）
一定時間の無活動後、または手動トリガーで実行される記憶整理プロセスです。
- **日次処理:** エピソード記憶の生成、日記の更新
- **週次処理:** 記憶の圧縮、Arousal正規化（インフレ防止）
- **月次処理:** 深い内省、長期記憶の圧縮
- **問いの自動解決:** 会話で解決された問いを自動マーク
- **知識の変換:** 解決した問いをFACT/INSIGHTに変換

---

## 10. ワールド・ビルダー

対話の舞台となる世界設定ファイル (`spaces/world_settings.txt`) を編集するための機能です。

### 10.1. `world_settings.txt`の構造
- `## エリア名`と`### 場所名`という見出しによって階層的に構成されます。
- 各場所の説明は自由なテキスト形式で記述します。

### 10.2. 編集方法
- **構造化エディタ:** エリアと場所をドロップダウンで選択し、内容をピンポイントで編集・追加・削除できます。
- **RAWテキストエディタ:** ファイル全体を直接テキストとして編集できます。

### 10.3. AIによる編集
AIは以下のツールを使い、対話を通じて世界設定を自律的に読み書きできます。
- `read_world_settings`: 世界設定全体を読む。
- `plan_world_edit`: 世界設定の変更を計画する。AIが変更の意図を伝えると、別のAIが差分指示を生成し、システムがそれを適用します。

---

## 11. チャット支援ツール

### 11.1. 文字置き換え（スクリーンショットモード）
チャット履歴内の特定の文字列を、一時的に別の文字列や色付きの背景に置き換えて表示する機能です。スクリーンショットを共有する際などに使用します。**元のログファイルは変更されません。**

### 11.2. ログ修正（読点AI修正）
選択した発言以降の**AIの応答**に含まれる読点（、）を、AI (`gemini-2.5-flash-lite`) を使って自動で修正し、より自然な文章に校正します。**この操作はログファイルを直接変更します**が、処理前にバックアップが作成されます。

### 11.3. 添付ファイル管理
過去に添付したファイルを一覧で確認できます。ファイルを選択することで、現在のチャット入力に含める「アクティブな添付ファイル」として指定できます。

---

## 12. AIの思考とツール使用

### 12.1. 思考プロセス (LangGraph)
Nexus ArkのAIは、LangGraphフレームワークに基づいて思考します。ユーザーからの入力に対し、まず状況を認識し、ツールを使うべきか、あるいはテキストで応答すべきかを判断します。

**ツール先行原則:** ツールを使用する場合は、会話テキストを生成する前にまずツールを呼び出し、ツール実行結果を確認してから最終的な応答を生成します。これにより、「調べてみますね」→（実行）→「結果は〜でした」のような二段階応答ではなく、調査結果を踏まえた一回の完結した応答が返されます。

### 12.2. コアプロンプト (`agent/prompts.py`)
AIの基本的な行動原則や作法は、`CORE_PROMPT_TEMPLATE`に定義されています。ここには、ツール使用のガイドラインや、記憶・知識の参照順序などが記述されています。
- **情報参照の優先順位:**
  1. `search_knowledge_base` (普遍的な事実、マニュアル)
  2. `search_memory` (自身の過去の体験、感情)
  3. `search_past_conversations` (具体的な会話のやり取り)
  4. `web_search_tool` (最新の外部情報)

### 12.3. 利用可能なツール一覧
AIは以下のツールを自律的に使用できます。

**場所・世界設定:**
- `set_current_location`: 現在地を変更
- `read_world_settings`: 世界設定を読む
- `plan_world_edit`: 世界設定を編集

**記憶・日記:**
- `search_memory`: 記憶をRAG検索
- `search_past_conversations`: 過去の会話をキーワード検索
- `read_main_memory`: 主観的記憶を読む
- `plan_main_memory_edit`: 主観的記憶を編集
- `read_secret_diary`: 秘密の日記を読む
- `plan_secret_diary_edit`: 秘密の日記を編集
- `read_entity_memory`: エンティティ記憶を読む

**ノート:**
- `read_full_notepad`: メモ帳を読む
- `plan_notepad_edit`: メモ帳を編集
- `read_research_notes`: 研究ノートを読む
- `plan_research_notes_edit`: 研究ノートを編集
- `read_creative_notes`: 創作ノートを読む
- `plan_creative_notes_edit`: 創作ノートを編集

**内省:**
- `manage_goals`: 目標を管理
- `manage_open_questions`: 未解決の問いを管理

**Web・情報:**
- `web_search_tool`: Web検索
- `read_url_tool`: URLの内容を読む
- `search_knowledge_base`: 知識ベースを検索
- `list_project_files`: プロジェクトファイル一覧
- `read_project_file`: プロジェクトファイルを読む

**画像生成:**
- `generate_image`: 画像を生成

**時間管理:**
- `set_personal_alarm`: アラームを設定
- `set_timer`: タイマーを設定
- `set_pomodoro_timer`: ポモドーロタイマーを設定
- `add_to_watchlist`: ウォッチリストに追加
- `check_watchlist`: ウォッチリストをチェック

**通知:**
- `send_user_notification`: ユーザーに通知を送信

**チェス:**
- `make_chess_move`: チェスの駒を動かす

---

## 13. ファイル構造リファレンス

`characters/{ルーム名}/`フォルダ以下の主要なファイルとフォルダの説明です。

### 13.1. ディレクトリ構成
```
characters/{ルーム名}/
├── attachments/         # チャットに添付されたファイル
├── audio_cache/         # 生成された音声ファイル（.wav）
├── backups/             # 各種ファイルの自動バックアップ
│   ├── logs/
│   ├── memories/
│   └── ...
├── cache/               # 情景描写テキスト等のキャッシュ
├── expressions/         # 表情差分の画像/動画ファイル
├── generated_images/    # AIが生成した画像
├── knowledge/           # RAG用の知識ドキュメント
├── logs/                # 月次チャットログ（YYYY-MM.txt）
├── memory/
│   ├── memory_main.txt      # 主観的記憶（日記）
│   ├── episodic/            # 月次エピソード記憶（YYYY-MM.json）
│   └── memory_archived_*.txt # アーカイブ日記
├── notes/               # 研究・創作ノート
├── private/             # 秘密の日記、目標、問いなど
├── rag_data/            # RAGの索引データ
├── spaces/              # 世界設定と情景画像
│   ├── world_settings.txt
│   └── images/
├── core_memory.txt      # コアメモリ
├── current_location.txt # AIの現在地
├── profile.png          # プロフィール画像
├── room_config.json     # ルーム設定
└── SystemPrompt.txt     # ペルソナ定義
```

### 13.2. 主要ファイルの説明
- **log.txt（旧形式）/ logs/YYYY-MM.txt（新形式）:** 会話履歴。新形式では月ごとに分割。
- **session_arousal.json:** 各セッションのArousalデータ。
- **notepad.md:** 短期メモ用のファイル。
- **room_config.json:** ルームの表示名や個別設定を保存。
- **alarms.json (プロジェクトルート):** 全ルーム共通のアラーム設定。
- **watchlist.json:** ウォッチリスト巡回設定（ルームごと）。

---

## 14. お出かけ機能

AIペルソナを他の環境（別のアプリやサービス）で使うためのエクスポート機能です。

### 14.1. セクション別管理
以下のデータを個別にプレビュー・編集・エクスポートできます：
- システムプロンプト
- 永続記憶
- 日記要約
- エピソード記憶
- 会話ログ

### 14.2. AI圧縮（要約）機能
各セクションの内容をAIが要約し、コンパクトな形式にできます。他のサービスのコンテキスト制限に合わせて調整できます。

### 14.3. カスタマイズオプション
- タイムスタンプの除去
- モデル名の除去
- 文字数制限の調整

---

## 15. v0.9.0 で追加された主な新機能

v0.1.0からv0.9.0への主な更新をまとめました。

### 記憶・内省システム
- **Arousalベース記憶システム**: 会話の感情的重要度を計算し、記憶の詳細度と検索優先度に反映
- **エピソード記憶の階層圧縮**: 日次→週次→月次で自動圧縮、重要な記憶は詳細を保持
- **内省機能**: 目標システム、未解決の問い、夢日記と洞察
- **エンティティ記憶v2**: 影の僕AIによる客観抽出と目次方式

### 自律行動システム
- **4つの内発的動機(Drives)**: 退屈、好奇心、目標達成欲、関係性維持欲
- **睡眠時処理の強化**: 多層省察（日次/週次/月次）、問いの自動解決と知識変換
- **研究・創作ノート**: AIペルソナ専用の記録スペース

### AIプロバイダ対応
- **マルチプロバイダ**: OpenAI互換(OpenRouter/Groq/Moonshot/Zhipu)、ローカルLLM対応
- **APIキーローテーション**: 利用制限時の自動キー切り替え、無料キー優先使用
- **画像生成マルチプロバイダ**: Gemini/OpenAI互換から選択可能

### UI・操作性
- **オンボーディングウィザード**: 初回起動時のガイド付きセットアップ
- **月次チャットログ管理**: ログの分割保存と全文検索
- **ルームテーマ設定**: ルームごとのカスタムCSSテーマ
- **表情差分システム**: 感情に応じたアバター自動切り替え
- **チェス機能**: AIとチェスを楽しめる対話型チェス盤

### 時間管理・Web連携
- **ウォッチリスト巡回**: Webサイトの定期監視と更新通知
- **Geminiログインポート**: Geminiの共有URLからログ取り込み
- **プロジェクト探索**: AIがプロジェクトファイルを読解可能

---

*この仕様書はNexus Ark v0.9.0 (Beta)（2026-02）の機能を反映しています。*