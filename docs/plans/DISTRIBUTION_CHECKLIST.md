# 📦 Nexus Ark 配布チェックリスト

配布準備および今後のリリースで必要な作業をまとめた永続的なドキュメントです。

---

## 🔧 配布前の必須作業

### 1. バージョン更新
- [x] `constants.py` の `APP_VERSION` を更新
- [x] `version.json` の `version` と `release_date` を更新

### 2. 開発ファイルのクリーンアップ
- [x] `pyproject.toml` への依存関係移行 ✅
- [x] `requirements.txt` の削除（uv移行完了後）
- [x] `start.sh` を uv 使用に更新（自動インストール機能付き）

### 3. 仕様書の更新
- [x] `docs/NEXUS_ARK_SPECIFICATION.md` を現在の実装に合わせて更新
  - ルームごとのCSSテーマ設定
  - Arousalベース記憶システム
  - 内省機能（目標・未解決の問い・夢日記）
  - 複数プロバイダ対応
  - 月次ログ分割管理
  - ウォッチリスト巡回、チェス、ログインポート等

### 4. 配布用サンプルペルソナ（オリヴェ）の整備
場所: `assets/sample_persona/Olivie/`

- [x] `room_config.json` にテーマ設定を反映
- [x] `rag_data/` に仕様書のRAGインデックスを事前構築 ✅ (29チャンク, 356KB)
- [x] `SystemPrompt.txt` の内容確認 ✅
- [x] `log.txt` の初期内容確認 ✅


### 5. ビルド & 検証
- [x] `python tools/build_release.py` を実行
- [ ] クリーン環境での起動テスト（Pinokio含む）


### 6. 既存ユーザーのマイグレーション戦略

#### 基本方針
**上書きインストールではなく、新規インストール + データ移行**

#### 移行フロー
```
1. 新環境にNexus Arkをインストール
2. 初回起動時にマイグレーションオプションを表示
3. ユーザーが旧フォルダのパスを指定
4. 以下をコピー:
   - config.json → 新環境へ
   - characters/* → 新環境へ
   - alarms.json → 新環境へ（あれば）
   - redaction_rules.json → 新環境へ（あれば）
   - .gemini_key_states.json → 新環境へ（あれば、v0.9.0以降）
5. オリヴェの更新:
   - CSSテーマ設定を追加（なければ）
   - 仕様書を knowledge/ に配置
   - RAGデータを rag_data/ に配置
```

#### 実装タスク
- [x] マイグレーションウィザードUIの作成（基盤実装完了）
- [x] `tools/migrate_from_old.py` スクリプト作成（二段階移行ロジック搭載）
- [x] 旧バージョン判定ロジック（version.jsonチェック、Auto-discovery）
- [x] オリヴェへの要素注入（最新仕様書、RAG、情景描写テキスト、CSSマージ）

#### 注意点
- 旧環境は**削除しない**（ユーザーの安全のため）
- 移行後に「移行完了」フラグを設定
- 既に移行済みの場合はスキップ


### 7. フォルダ構造の改善（ユーザビリティ向上）🔵 見送り
> **見送り理由**: 既存ユーザーへの影響が大きく、初回リリースではシンプルな構造を維持。将来バージョンで検討。

**目的**: ユーザーがアクセスするデータを `app/` の外に配置

~~**目標構造**~~:
```
Nexus Ark/
├── Start.bat / Start.sh
├── README.md
├── characters/      ← ユーザーデータ（app外に移動）
├── config.json      ← 設定ファイル（app外に移動）
└── app/             ← アプリ本体（ユーザーは触らない）
```

~~**変更が必要な箇所**~~:
- [~] `room_manager.py` - キャラクターパス参照の基準変更
- [~] `config_manager.py` - config.json パス変更
- [~] `nexus_ark.py` - 起動時のパス解決（親ディレクトリ参照）
- [~] `start.sh` / `Start.sh` - 作業ディレクトリ設定
- [~] 画像アップロード系 - 保存先パス調整
- [~] `tools/build_release.py` - ビルド時の構造変更
- [~] README_DIST.md - フォルダ構成説明の更新

~~**移行の注意点**~~:
- 既存データ（app/characters/*）の自動移動または互換性維持
- room_data.json内の画像パス参照の修正
- 相対パス計算の変更（../characters/ など）

---

---

---

## ⛔ 配布パッケージから除外すべきファイル

開発環境のデータを誤って配布しないためのリスト。
`tools/build_release.py` で除外設定を確認すること。

### ユーザー固有データ（絶対に含めない）
| ファイル/フォルダ | 内容 |
|------------------|------|
| `config.json` | APIキー等の設定 |
| `characters/` | 実際のキャラクターデータ |
| `alarms.json` | アラーム設定 |
| `redaction_rules.json` | 検閲ルール |
| `.gemini_key_states.json` | APIキーローテーション状態 |

### 開発・キャッシュ（含めない）
| ファイル/フォルダ | 内容 |
|------------------|------|
| `.venv/` | 仮想環境 |
| `__pycache__/` | Pythonキャッシュ |
| `.memos/` | デバッグログ |
| `dist/` | ビルド出力 |
| `.git/` | Gitリポジトリ |
| `.gemini/` | Gemini設定 |
| `backups/` | 設定バックアップ |
| `MagicMock/` | テスト用モック |
| `rooms/` | 空の旧フォルダ |
| `scripts/` | 開発スクリプト |
| `*.pyc` | コンパイル済みファイル |

---

## 🚀 将来の配布システム改善

### Phase 1: 現在完了 ✅
| 項目 | 状態 |
|------|------|
| uv による環境管理 | ✅ |
| Pinokio 対応 (`pinokio.js`) | ✅ |
| start.sh の uv 自動インストール | ✅ |

### Phase 2: 次のマイルストーン
| 項目 | 説明 |
|------|------|
| [x] 仕様書の完全更新 | オリヴェの知識ベース更新 ✅ |
| [x] RAGデータ事前ビルド | 初回起動を高速化（オリヴェ対応済） |
| [x] マイグレーションツール | 既存ユーザーのデータ移行（実装・検証完了） |
| [ ] Pinokio 実機テスト | 実際のインストール確認 |

### Phase 3: 将来課題
| 項目 | 説明 |
|------|------|
| [ ] TUF/tufup 更新システム | 署名ベースの安全な差分更新 |
| [ ] 自動更新チェック | 起動時に新バージョン通知 |
| [ ] Pre-built Wheel Dispatcher | GPU自動検出・最適化 |
| [ ] Windows ポータブル対応 | Import再順序化ハック |

---

## 📝 仕様書更新ガイド

仕様書はオリヴェがユーザーの質問に答えるための知識ベースです。

### 更新時の注意点
1. **ユーザー視点で書く**: 「何ができるか」「どう使うか」を重視
2. **CHANGELOGを参照**: 未記載機能の確認

### 追記が必要なセクション案
- ルームテーマ設定
- 記憶の重要度（Arousal）システム
- 内省機能
- 複数AIプロバイダ対応
- ログ管理の詳細

---

## 📎 関連ドキュメント

- [配布システム計画](distribution_system_plan.md)
- [配布調査レポート](../research/配布調査.md)
