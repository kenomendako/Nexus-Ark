# 司会AI（Supervisor）不具合調査ログ

配布後の機能再開に向け、これまでに判明した問題点と原因をまとめます。

## 1. 判明している問題点

### A. チャット欄での応答消失
- **症状**: ターミナルログではAIが発言しているが、チャット画面には最後の一人分しか残らない（または全員分消える）。
- **原因**: `gemini_api.py` のエラーハンドリング。APIエラー（429等）発生時に履歴を含まずにエラーメッセージのみを返していたため、UI側のヒストリスライス（過去10件のみ表示等）によってエラーそのものが画面に表示されず、「無反応」に見えていた。
- **暫定対策**: `gemini_api.py` でエラー時も全履歴を保持してyieldするよう修正済み。

### B. 多重応答ループ
- **症状**: 1回のユーザー入力に対し、Supervisorの決定を無視して全AIが順に話し出したり、同じAIが2回話したりする。
- **原因**: `ui_handlers.py` の二重構造。Supervisor自体が「次に誰が話すか」をループ制御しているにも関わらず、外側のUIハンドラも `all_rooms_in_scene` でループを回していたため、制御が競合していた。
- **暫定対策**: `enable_supervisor` 有効時はUI側の各AIループをスキップするガードを記述。

### C. モデル・プロバイダの取り違え
- **症状**: 特定のAI（例: Zhipu AI）を設定しているのに、別のプロバイダ（例: Moonshot AI）が呼び出される。
- **原因**: 話者交代時の `generation_config` および `room_name` の同期不足。LangChainのグラフ内で `state["next"]` だけを変えても、モデルクライアントを初期化する際の設定が「直前の話者」のままになっていた。
- **暫定対策**: `supervisor_node` 内で交代先のルーム設定を `get_effective_settings` で再取得し、Stateを完全に同期するロジックを実装。

## 2. 今後の課題（配布後の改善ポイント）
- **プロンプトの安定化**: SupervisorがJSONではなく「思考」や「挨拶」を返してしまう問題。より強力なfew-shotプロンプトや、強制パースロジックの強化が必要。
- **思考共有の負荷**: 全参加者の思考を一つのコンテキストに詰め込むと、トークン消費が激しくなり、429エラーを誘発しやすい。思考ログをあえてSupervisorに読ませない（あるいは要約する）選択肢の検討。

---
**ステータス**: 配布優先のため上記ロジックを維持したまま、フロントエンドおよびエントリポイントで機能を「封印（無効化）」済み。
