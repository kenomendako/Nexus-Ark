# レポート：Supervisor AI安定化と一時封印

**日付:** 2026-02-05  
**ブランチ:** `fix/agent-stability-and-settings-v2`  
**ステータス:** ✅ 完了（機能封印済み）

---

## 問題の概要

グループ会話における司会AI（Supervisor）の動作が不安定（応答消失、多重ループ、モデル取り違え）であり、配布に支障をきたしていた。コアとなるロジック修正を施した上で、ユーザーの要請に基づき、配布時の安定性を最優先するため機能を一時的に「封印（隠蔽・無効化）」した。

---

## 修正内容

1. **エラー通知の可視化 (`gemini_api.py`)**  
   APIエラー時に履歴が消えて沈黙する問題を修正。エラー時も現在の履歴を保持して返すように変更。
2. **多重ループの適正化 (`ui_handlers.py`)**  
   Supervisor有効時に発生するUI側ループとの競合を解消するガードを実装。
3. **モデル設定同期の強化 (`agent/graph.py`)**  
   話者交代時に交代先の設定（モデル名、APIキー等）を完全に同期するロジックを実装。
4. **機能の一時封印（配布優先対応）**  
   - UI (`nexus_ark.py`): チェックボックスを `visible=False` に設定。
   - ハンドラ (`ui_handlers.py`): `enable_supervisor = False` を強制。
   - グラフ (`agent/graph.py`): `supervisor_node` に早期リターン（強制スキップ）を追加。

---

## 変更したファイル

- `nexus_ark.py` - Supervisorチェックボックスの非表示化
- `ui_handlers.py` - ループ解消ガードの実装と機能の強制無効化
- `gemini_api.py` - エラー発生時の履歴保持ロジックの追加
- `agent/graph.py` - 設定同期の強化と早期リターンの追加

---

## 検証結果

- [x] アプリ起動確認（`python3 nexus_ark.py` で起動可能であることを確認）
- [x] 機能動作確認（封印状態で1対1、通常のグループ会話が安定動作することを確認）
- [x] 副作用チェック（`validate_wiring.py` を実行。今回の修正に起因する新規エラーがないことを確認）

> [!NOTE]
> `validate_wiring.py` のエラー（handle_message_submission等）は既存のジェネレータ・動的戻り値に関するものであり、今回の修正による退行ではありません。

---

## 残課題

- **司会AI機能の再開**: 配布後に改めて、プロンプトの安定化とモデル取り違えの根本治療を行う。
- **不具合調査ログの共有**: `docs/technical/supervisor_issues_debug_log.md` に知見をまとめてあります。
