# 推定入力トークン数の計算精度の改善 レポート

## 1. 概要
ユーザーから報告された、推定入力トークン数と実際の消費トークン数の大きな乖離（例: 推定 51k vs 実入力 32k）を調査し、ロジックを修正しました。

## 2. 調査結果
乖離の主な原因は以下の3点に集約されました。

- **ツールの過大見積もり**: ツール1件あたり一律 400トークン 加算していましたが、実際のツール定義（LangChain schema）は約 160トークン でした。44ツールで約 10,000トークンの誤差が出ていました。
- **安全係数の過剰適用**: メッセージ本体とツール見積もりの合算に対して `1.1倍` を掛けていたため、ツールの誤差がさらに増幅されていました。
- **プレースホルダーの乖離**: 検索結果（RAG）や自己意識コンテキストの見積もりに使用していた「サンプル文字列」が、実際の内容よりも大幅に長く設定されていました。

## 3. 実施した対策

### 3.1 ツールオーバーヘッドの適正化
ツール1件あたりの見積もりを **250トークン** に調整しました。
- 実測値 (160) に対して十分なマージンを確保しつつ、400 という過大な値からの削減を行いました。

### 3.2 安全係数の微調整
最終的な計算式を以下のように微調整しました。
- 旧: `int(total_tokens * 1.1) + 100`
- 新: `int(total_tokens * 1.15) + 500`
- **理由**: 当初係数を下げましたが、LangChain のメタデータ付与分などで過小見積もりが発生したため、最終的に 1.15倍 + 500 とすることで、実測値に対して数%（約1kトークン程度）多い、「安全かつ正確な」見積もりを実現しました。

### 3.3 コンテキスト・プレースホルダーの更新
RAG検索結果、エピソード記憶要約、自己意識（目標・動機）などの見積もり用文字列を、実際の生成内容に近い現実的な長さに更新しました。

## 4. 検証結果
ユーザーによる実対話での検証結果：
- **入力(推定)**: 29.5k
- **実入力**: 28.7k
- **実合計**: 29.2k

乖離は約 0.8k (約2.8%) となり、不意の文字数制限（要約未発動によるパンク）を防ぎつつ、精度の高いコスト予測が可能であることを確認しました。

## 5. 結論
本修正により、トークン数表示の信頼性が大幅に向上しました。これにより、自動要約が適切なタイミングで発動し、長期的な会話の安定性が確保されます。
