# レポート: 429 RESOURCE_EXHAUSTED 時の即時キーローテーションの改善

## 概要
Gemini API で 429 エラー（クォータ制限）が発生した際、SDK や内部ロジックによる不必要なリトライと待機時間が発生し、API キーのローテーションが大幅に遅延する問題を修正しました。

## 修正内容

### 1. agent_node のリトライ抑制 (agent/graph.py)
- `agent_node` 内の retry loop (3回) において、429 エラーを検知した場合は `time.sleep` や `continue` を行わず、即座に例外を `raise` するようにしました。
- これにより、上位の `invoke_nexus_agent_stream` に即座に制御が戻り、キーローテーションが開始されます。

### 2. ローテーション待機時間の短縮と検知の強化 (gemini_api.py)
- `invoke_nexus_agent_stream` におけるローテーション時の `time.sleep` を 1.0s から 0.1s に短縮しました。
- `ResourceExhausted` 例外の直接的な捕捉に加え、エラーメッセージの文字列チェックによる 429 検知を強化し、より確実にローテーションがトリガーされるようにしました。

## 期待される効果
- 無料キーが枯渇した際、ユーザーが気づかないほどの短時間（ミリ秒〜数百ミリ秒単位）で次の有効なキーに切り替わり、応答が生成されます。
- 「Wait 54.33s...」のような長時間の待機ログが出力される頻度が激減します。

## 完了したタスク
- [x] 現状の調査 (gemini_api.py / graph.py)
- [x] agent_node の 429 時即時停止の実装
- [x] invoke_nexus_agent_stream のローテーション高速化
- [x] 実装計画とウォークスルーの作成
