# レポート: 応答再生成時の添付ファイル復元

**日付:** 2026-02-01  
**ブランチ:** `fix/regeneration-attachments`  
**ステータス:** ✅ 完了

---

## 問題の概要

「🔄 再生成」ボタンを押してAIの応答をやり直す際、直前のメッセージに含まれていた画像やテキストファイル等の添付ファイルがAPIリクエストに含まれない問題が発生していました。これは、再生成時にログからテキストのみを復元しており、添付ファイルの情報を無視していたことが原因です。

---

## 修正内容

1.  **添付ファイル処理の共通化**:
    *   `ui_handlers.py` に `_create_api_parts_from_files` ヘルパー関数を新規作成。
    *   ファイルパスのリストを受け取り、画像リサイズ（768px制限）やBase64エンコードを行い、API用のパーツリストを生成するロジックをここに集約しました。
2.  **新規メッセージ送信時のリファクタリング**:
    *   `handle_message_submission` で冗長だったファイル処理ロジックを上記ヘルパー関数に置き換えました。
3.  **再生成ハンドラの修正**:
    *   `handle_rerun_button_click` で、ログから読み出したテキスト内の `[ファイル添付: /path/to/file]` マーカーを正規表現で解析するようにしました。
    *   抽出したファイルパスを `_create_api_parts_from_files` に渡し、APIリクエストの `user_prompt_parts` に含めるようにしました。
    *   API送信用のテキストからはマーカーを除去し、AIがマーカー自体を指示として受け取らないようクリーンアップ処理を追加しました。

---

## 変更したファイル

- `nexus_ark/ui_handlers.py` - ヘルパー関数の追加、`handle_message_submission` のリファクタリング、`handle_rerun_button_click` の実装。
- `nexus_ark/CHANGELOG.md` - 修正内容の追記。

---

## 検証結果

- [x] アプリ起動確認
- [x] 機能動作確認 (テストスクリプト `test_rerun_logic.py` にて、マーカーのパースとパーツ生成ロジックの正当性を確認済み)
- [x] 副作用チェック (新規メッセージ送信機能に影響がないことを確認、コード構造の整理により可読性が向上)

---

## 残課題（あれば）

なし。
