# レポート：ノート管理の刷新と自動アーカイブ機能の実装

**日付:** 2026-02-02  
**ブランチ:** `feat/implement-note-organization`  
**ステータス:** ✅ 完了

---

## 問題の概要

ノートファイル（`creative_notes.md`, `research_notes.md`）が肥大化すると、AIが情報を読み込む際のコンテキストを圧迫し、レスポンスの遅延や精度の低下を招く問題がありました。また、これまではファイルが単一だったため、過去の情報の整理が困難でした。

---

## 修正内容

1.  **ディレクトリ構造の刷新**:
    *   ノートファイルを各ルームの `notes/` ディレクトリに集約。
    *   過去の記録を保存するための `notes/archives/` ディレクトリを導入。
2.  **自動アーカイブ機能の実装**:
    *   ファイルサイズが上限（200KB）を超えた場合、自動的にタイムスタンプ付きの別ファイルへ退避し、メインファイルをリセットする機能を実装。
    *   UIでの保存時およびAIツールの書き込み時にチェックとアーカイブが実行されます。
3.  **UIの拡張（閲覧機能）**:
    *   「創作ノート」および「研究・分析ノート」セクションに対象ファイル選択用のドロップダウンを追加。
    *   過去のアーカイブをシームレスに切り替えて閲覧・フィルタリングできるようになりました。
4.  **RAG索引の更新**:
    *   アーカイブされたノート（`notes/archives/*.md`）も自動的に索引対象に含まれるよう拡張しました。

---

## 変更したファイル

- `constants.py`: ノート関連の定数（ディレクトリ名、ファイル名、サイズ上限）を追加。
- `room_manager.py`: ディレクトリ作成、レガシー移行ロジック、アーカイブ実行、ファイルリスト取得関数を実装。
- `ui_handlers.py`: ノート読み込み/保存時のアーカイブ対応、UIリフレッシュロジックの修正。
- `nexus_ark.py`: ノート閲覧用ドロップダウンおよび更新ボタンのUI配置、イベントハンドラの紐付け。
- `rag_manager.py`: `notes/` および `archives/` を走査対象に追加。
- `tools/creative_tools.py` / `research_tools.py` / `notepad_tools.py`: 書き込み前の自動アーカイブ処理を統合。

---

## 検証結果

- [x] アプリ起動確認：正常起動を確認。
- [x] 既存ノートの移行：レガシーファイルが `notes/` 下へ正しく移動されることをテストで確認。
- [x] アーカイブ動作：200KB超のファイルが正常にアーカイブされ、メインファイルがリセットされることを確認。
- [x] UI連携：ドロップダウンでアーカイブを切り替えてエントリを表示できることを確認。
- [x] RAG同期：アーカイブ後もRAG検索で過去の情報を取得できることを確認。
- [x] UI配線検証：`validate_wiring.py` を実行。`handle_room_change_for_all_tabs` (155) および `handle_delete_room` (155) の整合性を確認済み。

---

## 残課題

なし
