# レポート：APIキーローテーションの信頼性向上

**日付:** 2026-02-01  
**ブランチ:** `fix/api-key-rotation-reliability`  
**ステータス:** ✅ 完了

---

## 問題の概要

APIキーのローテーション機能において、以下の不具合および改善点が特定されました：
1. **状態の消失**: APIキーの枯渇状態（429エラー）がメモリ上にしか保持されず、アプリの再起動や、メインプロセスとバックグラウンドプロセス（睡眠モード中等）の間で共有されない。
2. **保存漏れ**: ローテーションによって切り替わった新しいキー名が `config.json` に保存されず、次回起動時に古い（枯渇した）キーから始まってしまう。
3. **DreamingManagerの欠落**: 睡眠モード中のLLM呼び出しにローテーションロジックがなく、エラー発生時に処理が中断される。
4. **タイポ**: `gemini_api.py` 内で永続化用変数名のタイポがあり、正しく保存されていなかった。

---

## 修正内容

- **枯渇状態の永続化**: `.gemini_key_states.json` を導入し、APIキーの枯渇状態と復帰予定時刻をディスクに保存するようにしました。
- **DreamingManagerの強化**: LLM呼び出し用のヘルパーメソッド `_invoke_llm` を追加し、429エラー検知時に自動でキーをローテーションしてリトライする仕組みを導入しました。
- **保存ロジックの修正**: `gemini_api.py`, `rag_manager.py`, `dreaming_manager.py` でキーが切り替わった際、即座に `config.json` の `last_api_key_name` を更新するようにしました。
- **タイポ修正**: `last_used_api_key_name` を `last_api_key_name` に修正。

---

## 変更したファイル

- `config_manager.py` - 状態のロード/セーブ処理、および永続化連携の追加
- `gemini_api.py` - タイポ修正、ローテーション時の永続化追加
- `dreaming_manager.py` - `_invoke_llm` によるローテーション対応、インポート漏れ修正
- `rag_manager.py` - ローテーション時の永続化追加

---

## 検証結果

- [x] アプリ起動確認：`NameError` 修正後の正常起動を確認。
- [x] 機能動作確認：テストスクリプトにより、枯渇状態がファイルに書き込まれ、別プロセスから読み込めることを確認。
- [x] 副作用チェック：`validate_wiring.py` を実行。既存の配線不良（保存済み既知の問題）を除き、今回の修正による新たな不整合がないことを確認。

---

## 残課題（あれば）

なし。ローテーションの1周制限などは既存の実装を継承しており、期待通り動作します。
