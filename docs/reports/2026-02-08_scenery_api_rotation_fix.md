# レポート: 情景描写時の API キーローテーション不具合の修正

## 概要
情景描写機能において、使用中の Gemini API キーが制限（429 Resource Exhausted）に達した際、ローテーション設定が有効であっても自動的に次のキーに切り替わらず、エラーで停止してしまう問題を修正しました。

## 問題の詳細
調査の結果、以下の原因が特定されました：
1. `agent/scenery_manager.py` の `generate_scenery_context` 関数において、LLM の呼び出しに関するリトライロジックが欠如していた。
2. 429 エラーを検知しても、キーを「枯渇（exhausted）」状態としてマークする処理が行われていなかったため、`config_manager` が同じキーを返し続けていた。

## 修正内容

### 1. リトライ・ローテーションロジックの実装 (`agent/scenery_manager.py`)
- LLM 呼び出しを `max_retries=3` のループで包み、例外処理を追加。
- 429 エラー発生時、`config_manager.mark_key_as_exhausted()` を呼び出して現在のキーを使用不能として記録。
- `config_manager.get_active_gemini_api_key()` を再評価して、新しいキー（有料キーなど）を取得し、リトライを実行。

### 2. UI ハンドラの改善 (`ui_handlers.py`)
- `_get_updated_scenery_and_image` における例外処理を強化。
- リトライを使い切っても失敗した場合に、ユーザーに対して「API 制限に達した」ことを明確に伝えるメッセージを表示するように変更。

## 検証
- モックを使用したユニットテスト `test_api_rotation_fix.py` を作成（検証後に削除済み）。
- 1つ目のキーで 429 を発生させ、自動的に 2つ目のキーに切り替わって成功することを確認。

## 影響範囲
- 情景描写機能（テキスト生成）
- API キー管理システム（整合性を維持したまま利用）

---
作成日: 2026-02-08
修正担当: Antigravity
