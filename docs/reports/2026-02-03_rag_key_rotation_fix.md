# RAG検索時のAPIキーローテーション修正レポート

**日付**: 2026-02-03  
**タスク**: RAG検索時のAPIキーローテーション不具合修正  
**検証ステータス**: 検証済み (Mock Test & Smoke Test)

## 概要
RAG検索処理(`rag_manager.py`)において、検索実行時(embed_query)に429エラー(Resource Exhausted)が発生した場合、APIキーのローテーションが行われず、そのまま検索が失敗する不具合を修正しました。
検索処理をリトライループでラップし、429エラー検知時にキーをローテーションして再試行するように変更しました。

## 変更内容
### [Modify] `rag_manager.py`
- `search` メソッド内の動的インデックスおよび静的インデックスの検索呼び出しを、最大5回のリードトライループ内に配置しました。
- `try-except` ブロック内で `429` または `ResourceExhausted` エラーを捕捉した場合、`_rotate_api_key` を呼び出すようにしました。
- ローテーション成功時、ループを `continue` して検索を最初からやり直します（新しいキーで埋め込みモデルが再初期化されるため）。

## 検証結果

### 1. Mock Test (scripts/test_rag_retry_logic.py)
`unittest.mock` を使用して、`similarity_search_with_score` が初回呼び出し時に429エラーを返し、2回目に成功する状況をシミュレーションしました。

- **結果**: 
  - `_rotate_api_key` が呼び出されたことを確認。
  - 検索がリトライされ、結果が取得できたことを確認。
  - 重複除去機能が正常に動作し、正しい件数の結果が返却されたことを確認。

### 2. Smoke Test (scripts/test_rag_search_cycle.py)
実環境での初期化と実行確認を行いました（APIキーのエラー処理パスを含む）。

- **結果**: 
  - クラッシュすることなく実行完了。
  - 例外処理が機能し、アプリケーションが停止しないことを確認。

## 結論
RAG検索時のAPIキー枯渇に対する耐性が向上しました。これにより、無料枠のAPIキーを使い切った場合でも、自動的に次のキーに切り替わり、応答生成が中断されるリスクが低減されます。
