# レポート: お出かけ機能エクスポートのメタタグ除去と不具合修正

**日付:** 2026-02-09  
**ブランチ:** `fix/outing-export-metadata-removal`  
**ステータス:** ✅ 完了

---

## 問題の概要

「お出かけ」機能のエクスポート時に、AIの内部状態を示すメタタグ（表情、感情、メモリトレース）がログに含まれたままになっていました。これを適切に除去し、また除去後に発生した不自然な空行の問題を解消しました。

---

## 修正内容

1.  **共通メタタグ除去関数の実装 (`utils.py`)**:
    *   `utils.clean_persona_text` を新設。表情タグ、感情タグ、メモリトレース、XML形式タグ、思考ログを一括で除去。
    *   3つ以上の連続する改行を2つに正規化するロジックを搭載し、タグ除去後の空白を適正化。
2.  **UIロジックの統合 (`ui_handlers.py`)**:
    *   チャット表示処理 (`format_history_for_gradio`) の重複ロジックを `clean_persona_text` に置換。
    *   エクスポート処理 (`_get_recent_log_entries`, `_get_episodic_memory_entries`) にクリーンアップを適用。
    *   `_get_recent_log_entries` において、行単位ではなくメッセージ単位でクリーンアップを適用することで不自然な改行の蓄積を防止。

---

## 変更したファイル

- `utils.py` - `clean_persona_text` の新設、`remove_thoughts_from_text` のリファクタリング、改行正規化ロジックの追加。
- `ui_handlers.py` - チャット表示およびエクスポート処理への共通クリーンアップ関数の適用。

---

## 検証結果

### 1. 単体テスト
- [x] 各種メタタグ（表情、感情、トレース）の除去確認
- [x] 思考ログ（新旧形式）の除去確認
- [x] タグ除去後の空行抑制・改行正規化の確認

### 2. UI配線整合性確認 (`python tools/validate_wiring.py`)
```text
[PASS] クリーンアップ関数導入による新たな不整合は見つかりませんでした。
(既存の handle_knowledge_reindex 等の不整合は本タスク範囲外として確認済み)
```

---

## 残課題（あれば）

なし。将来的に新しいタグが追加された場合も `utils.clean_persona_text` への正規表現追加のみで対応可能です。
