# レポート：システムプロンプトのスリム化と不具合修正

**日付:** 2026-02-03  
**ブランチ:** `fix/remove-entity-list-from-prompt`  
**ステータス:** ✅ 完了

---

## 問題の概要

1. **システムプロンプトの肥大化**: 「記憶しているエンティティ一覧」が全件注入されていたため、トークン消費が激しく、コスト増とコンテキスト圧迫の原因となっていた。
2. **メッセージ削除機能のバグ**: チャットログからのメッセージ削除時に `NameError: name 'new_messages' is not defined` が発生し、削除が失敗していた。

---

## 修正内容

### 1. システムプロンプトの最適化
- `agent/prompts.py`: `{entity_list_section}` を `{pending_messages_section}` に改名。
- `agent/graph.py`: エンティティ名の一覧生成ロジックを削除。「影の僕からの提案」のみを `pending_messages_section` に注入するように変更。
- `gemini_api.py`: トークン計算ロジックからエンティティ一覧の読み込みを削除し、プレースホルダー名を同期。

### 2. 不具合修正
- `utils.py`: `delete_message_from_log` 関数内で `new_messages = []` の初期化を追加。

---

## 変更したファイル

- `agent/prompts.py` - プレースホルダーの名称変更
- `agent/graph.py` - エンティティ一覧注入の廃止、ペンディングメッセージの分離
- `gemini_api.py` - トークン見積もりロジックの更新
- `utils.py` - メッセージ削除時の NameError 修正
- `docs/plans/TASK_LIST.md` - タスク完了マーク

---

## 検証結果

- [x] アプリ起動確認：正常
- [x] 機能動作確認：
    - システムプロンプトからエンティティ一覧が消えていることを確認（内部ログ）。
    - ペンディングメッセージがある場合に正しく注入されることを確認。
    - チャットメッセージの削除がエラーなく完了することを確認。
- [x] 副作用チェック：記憶想起ツール（`recall_memories` 等）への影響がないことを確認。

---

## 残課題

- システムプロンプトキャッシュ効率向上のため、動的なセクションをプロンプトの後半に配置する検討（INBOXに追加済み）。
