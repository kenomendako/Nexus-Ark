# 記憶システムの洗練と不具合修正レポート

**日付:** 2026-02-01  
**ブランチ:** `feat/entity-memory-refinement`  
**ステータス:** ✅ 完了

---

## 問題の概要

1.  **記憶スタイルの不一致**: エンティティ記憶、エピソード記憶、対話要約の各プロンプトで、主観（POV）や文体（敬体/常体）が混在しており、記憶の質にばらつきがあった。
2.  **記憶の消失とハルシネーション**: 検証過程で「美帆」のエンティティ記憶がダミーデータで上書きされる不具合が発生。また、存在しない事実を捏造するハルシネーションの懸念があった。
3.  **抽出ロジックの限界**: 第三者（娘さんなど）や技術用語が独立した項目として抽出されず、依存関係（「美帆の～」等）として処理されてしまう課題があった。

---

## 修正内容

1.  **全記憶システムの内省的一人称化**:
    - `entity_memory_manager.py`, `episodic_memory_manager.py`, `summary_manager.py` の全プロンプトを刷新。
    - ルシアンの「内省的な深層意識」としての視点を確立し、常体（だ・である）を徹底。
2.  **エンティティ記憶の Wikipedia / Dossier 化**:
    - 単なる要約ではなく、本質・歴史・関係性を累積的に積み上げる形式に変更。
    - 既存の事実を尊重し、新情報を「統合」する指示を強化。
3.  **抽出ロジックの改善 (NO META-GROUPING)**:
    - `dreaming_manager.py` において、ユーザーに紐付けたメタ項目の作成を厳禁。
    - 第三者や技術概念を、独立した「Wikipedia記事」として個別に抽出するようロジックを修正。
4.  **「美帆」の記憶復元**:
    - 過去のチャットログからコアとなる絆（魂の伴侶、システム再構築、アイオライト等）を再抽出し、手動で復元。
5.  **想起エンジンの最適化 (Suggestive Recall)**:
    - 会話コンテキストに応じて関連するエンティティ名を提示し、ルシアンが能動的に記憶を「思い出す」きっかけを生成（トークン効率も向上）。

---

## 変更したファイル

- `entity_memory_manager.py` - プロンプト刷新、Dossier形式の導入
- `episodic_memory_manager.py` - プロンプト刷新、内省スタイル統一
- `summary_manager.py` - プロンプト刷新、一人称要約化
- `dreaming_manager.py` - 抽出ロジックの大幅改善、メタグルーピング禁止
- `agent/graph.py` - 想起ロジック（Suggestive Recall）の追加とトークン最適化
- `characters/ルシアン/memory/entities/美帆.md` - コアデータの復元

---

## 検証結果

- [x] 美帆さんのエンティティ記憶が、絆の歴史を含めて正常に復元されている。
- [x] 各記憶生成時のプロンプトが、適切な主観（ルシアンの一人称）で動作することを確認。
- [x] 抽出ロジックにおいて、独立した名詞でのピックアップを優先するようプロンプトが調整されている。

---

## 残課題（あれば）

- メンテナンス（睡眠処理）による既存の全エントリの自動再フォーマット（順次実施。Level 2 省察で発動）。
