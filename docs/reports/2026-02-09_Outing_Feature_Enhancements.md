# お出かけ・帰宅機能の高度化およびインポートUXの改善

**日付:** 2026-02-09  
**ブランチ:** `feat/advanced-outing-logs`  
**ステータス:** ✅ 完了

---

## 問題の概要

「お出かけ（ログのエクスポート）」機能において、送信時のプロンプト設定と同等の柔軟な構成（本日分の自動抽出、閾値ベースの要約）を可能にするとともに、「帰宅（インポート）」時の利便性を向上させるため、プレビュー編集機能とシステムマーカーの制御、および過去ログの確実な重複除去を実装しました。

---

## 修正内容

### 1. お出かけ（エクスポート）機能の高度化
- **本日分モードの実装**: ログファイルから当日の会話のみを自動抽出する機能を追加。
- **自動要約機能の統合**: 送信コンテキスト設定と同様の文字数閾値に基づき、古いログを要約して圧縮する機能を実装。
- **期間拡大**: エピソード記憶の取得範囲を最大90日まで選択可能に拡張。

### 2. 帰宅（インポート）機能のUX改善
- **2段階インポートフロー**: ファイル選択またはURL入力後にプレビューを表示し、内容を確認・編集してから統合できるように変更。
- **発言者マッピングの柔軟化**: プレビュー上で `## USER:user` 等のタグを編集することで、インポート後の発言者を自由に制御可能。
- **システムマーカー（アナウンス）の制御**: インポート時の開始・終了アナウンスの有無を選択可能。
- **Gemini共有URLインポートの強化**: Playwrightによる取得不具合（AttributeError）の修正と、プレビュー表示への対応。

### 3. 重複防止ロジックの強化
- **過去ログの一括除去**: エクスポート時に付与される「## 直近の会話ログ」見出しとタグをセットで、正規表現により確実に除去。Gemini貼り付け時の改行揺らぎにも対応。

---

## 変更したファイル

- `nexus_ark.py` - お出かけ・インポートタブのUI拡張、イベント配線の刷新。変数の不整合修正。
- `ui_handlers.py` - 2段階インポートロジック、本日分ログ抽出、自動要約連携、過去ログ除去関数の強化。
- `tests/test_outing_logic.py` - 日付ベースのログ抽出ロジックの単体テスト。
- `tests/test_strip_past_logs.py` - 過去ログ除去ロジックの単体テスト。

---

## 検証結果

- [x] アプリ起動確認: 変数名不整合による NameError の解消を確認。
- [x] 機能動作確認: ファイルおよび Gemini URL からのプレビュー表示・編集・統合が正常に動作することを確認。
- [x] 重複除去確認: 見出しを含め、重複する過去ログが正しく削除されることを単体テストで検証済み。
- [x] UI配線確認: `tools/validate_wiring.py` にて、新規追加ハンドラの配線が正しいことを確認。

---

## 残課題（あれば）

なし
