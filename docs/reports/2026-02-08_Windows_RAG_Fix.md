# 2026-02-08 Windows Distribution Fixes Report

## 1. 概要
Windows配布版Nexus Arkにおいて報告された2つの主要な不具合を修正しました。

1.  **メッセージ重複バグ**: APIエラー後の再生成やメッセージ削除時に、ログファイルが正しく更新されず、古いメッセージが重複して表示される。
2.  **RAG索引の初期化不全**: 配布データ（`faiss_index`）が正しく認識されず、起動時に「索引が作成されていません」と表示される。

## 2. 修正内容

### 2.1 メッセージ重複バグ (`utils.py`)
- **原因:** `_write_segmented_logs` 関数において、特定の月のメッセージが0件になった場合（全削除など）、その月のログファイルを上書き・削除するロジックが欠如していたため、古いファイルがそのまま残っていた。
- **修正:** ログ保存時に既存のログファイル一覧をスキャンし、新しいメッセージリストに含まれないファイル（＝メッセージがなくなった月）を明示的に削除するロジックを追加しました。

### 2.2 RAG索引の初期化不全 (`rag_manager.py`, `ui_handlers.py`)
- **原因:** 
    1.  `RAGManager` は遅延初期化（チャットや検索発生時にインスタンス化）される設計だったため、アプリ起動時に配布データの互換性チェック（`faiss_index`のリネーム）が走らなかった。
    2.  `rag_manager.py` にレガシーパス (`faiss_index`) の検出ロジックを追加したが、初期化されないため実行されなかった。
- **修正:**
    1.  `rag_manager.py`: `__init__` メソッド内で、古い `faiss_index` フォルダが存在し、新しい `faiss_index_static` がない場合に、自動的にリネームまたは読み取り専用モードでロードするロジックを実装。
    2.  `ui_handlers.py`: `get_rag_manager` ヘルパー関数を実装し、**アプリ起動時 (`handle_initial_load`) に強制的に初期ルームのRAGマネージャーをインスタンス化**する処理を追加。これにより、ユーザーが操作する前にマイグレーションが完了するようになりました。

## 3. 検証結果
- **メッセージ重複:** メッセージ削除後にログファイルがクリーンアップされ、重複が解消されたことを確認済み。
- **RAG:** 起動直後のコンソールログにて `Legacy index detected` および `Renamed to 'faiss_index_static'` が表示され、RAG検索が機能することを確認済み。

## 4. 今後の対応
- 今回の修正はロジック変更を含むため、v0.2.0 としてリリースします。
- 配布パッケージ作成時には、念のため `faiss_index` 名称のままでも `faiss_index_static` 名称でもどちらでも動作することを確認しますが、基本的には自動リネームに任せます。
