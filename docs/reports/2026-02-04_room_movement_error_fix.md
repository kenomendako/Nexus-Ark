# ルーム移動エラー修正レポート

**日付:** 2026-02-04  
**ブランチ:** `fix/room-movement-radio-error`  
**ステータス:** ✅ 完了

---

## 問題の概要

ルーム移動時（特に過去のバージョンで作成されたルームへ移動した際）に、`gradio.exceptions.Error` が発生して画面がフリーズする問題を修正しました。
原因は、ルーム設定ファイルに含まれるプロバイダ値（'zhipu'）が、Radioコンポーネントの有効な選択肢リストに含まれておらず、且つUIハンドラが返す「標準設定を使用（'default'）」も選択肢に登録されていなかったためです。

---

## 修正内容

### 1. UI定義への選択肢追加 (`nexus_ark.py`)
共通設定および個別設定の「プロバイダ選択」ラジオボタンに、`("標準設定を使用", "default")` を追加しました。これにより、UIハンドラから返されるデフォルト値を正常に受け入れられるようになりました。

### 2. レガシー設定のサニタイズ (`ui_handlers.py`)
`_update_chat_tab_for_room_change` 関数内で、プロバイダ値をUIに反映する前にサニタイズする処理を追加しました。
- `zhipu`, `groq`, `ollama`, `local` を `openai` に変換。
- その他の未知の値を `default` に変換。

---

## 変更したファイル

- `nexus_ark.py` - Radioコンポーネントの `choices` を更新。
- `ui_handlers.py` - プライバシー値をサニタイズしてからUI更新タプルを返すように修正。

---

## 検証結果

- [x] アプリ起動確認：正常
- [x] 機能動作確認：'zhipu' 設定を持つルームへの移動がエラーなく行われ、自動的に 'OpenAI互換' として扱われることを確認（`verify_fix.py` による検証済み）。
- [x] UI配線チェック (`tools/validate_wiring.py`)：実行済み。私の変更に関連する新たなエラーはなし（既存の警告のみ）。

---

## 残課題

なし。後方互換性が確保されたため、配布済みの設定ファイルを持つユーザーもそのまま移行可能です。
